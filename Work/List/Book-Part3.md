<!-- markdownlint-disable-file MD033 -->

# 第三部分：数据准备和结构化 <div id="page_201"></div>

本节演示清理和构建凌乱的真实数据以支持Tableau中的分析的技术。 它着重于使用Tableau Desktop和Tableau Prep解决数据挑战。

本节包括以下章节：

- [第9章](docs/Book.md#page_202)，*第九章 清理和构建混乱数据*
- [第10章](docs/Book.md#page_217)，*Tableau Prep介绍*

## 第九章 清理和构建混乱数据 <div id="page_202"></div>

到目前为止，我们在本书中看到的大多数示例都假定数据结构良好且相当干净。现实世界中的数据并不总是那么漂亮。可能是凌乱的或者结构不好。它可能缺少值或具有重复的值，或者细节级别错误。

您如何处理这些混乱的数据？在下一章中，我们将Tableau Prep Builder视为清理和构建数据的可靠方法。现在，让我们专注于Tableau  Desktop固有的功能，它本身提供了很多选项和灵活性来处理数据问题。我们将研究一些特性和技术，这些特性和技术将使您克服数据结构的障碍。我们还将为良好的数据结构打下坚实的基础。知道哪种数据结构可以与Tableau一起很好地工作是了解如何解决某些问题的关键。

在本章中，我们将重点介绍一些用于构造数据以使其与Tableau一起良好工作的原理，以及一些如何解决常见数据问题的特定示例。本章将涵盖以下主题：

- 为Tableau构建数据
- 联合和跨数据库联接
- 处理数据结构问题的技术
- 数据问题高级修复概述

### 为Tableau构建数据 <div id="page_203"></div>

我们已经看到Tableau可以连接到几乎任何数据源。无论是内置的直接连接，ODBC，还是使用Tableau数据提取API生成数据提取，都没有数据超出限制。但是，某些结构使数据在Tableau中更易于使用。

要确保与Tableau一起良好工作的数据结构，有两个关键：

- 源数据连接的每条记录都应具有有意义的详细程度
- 源中包含的每个度量都应与详细程度相匹配，或可能处于较高的详细程度，但绝对不应处于较低的详细程度

例如，假设您有一张考试成绩表，每所学校的每个教室都有一条记录。在记录中，您可能有三个度量：教室的平均GPA，班级学生人数和学校的平均GPA：

| **学校**   | **课堂** | **平均GPA** | **学生人数** | **学生人数（学校）** |
| ---------- | -------- | ----------- | ------------ | -------------------- |
| 皮卡小学   | 4 个等级 | 3.78        | 153          | 1,038                |
| 皮卡小学   | 5 个等级 | 3.73        | 227          | 1,038                |
| 皮卡小学   | 6 个等级 | 3.84        | 227          | 1,038                |
| 麦考德小学 | 4 个等级 | 3.82        | 94           | 915                  |
| 麦考德小学 | 5 个等级 | 3.77        | 89           | 915                  |
| 麦考德小学 | 6 个等级 | 3.84        | 122          | 915                  |

前两项指标（**平均GPA**和**学生人数**）与个人数据记录（学校中每个教室）的详细程度相同。**学生人数（学校）**的详细程度更高（每个学校）。只要您知道这一点，就可以进行仔细的分析。但是，如果您尝试将每个学生的GPA存储在班级记录中，则会出现数据结构问题。如果数据的结构是为了存储每个年级的所有学生的GPA（也许每个学生都有一列，或者包含用逗号分隔的学生分数列表的单个字段），那么我们需要做一些工作使数据在Tableau中更可用。

了解源**的详细**程度（通常称为**粒度**）至关重要。每次连接到数据源时，您首先要问和回答的问题是：一条记录代表什么？例如，如果您要将“记录数”字段拖放到视图中并观察到1,000条记录，那么您应该能够完成该语句，*我有1,000 _____*。可能是1,000名学生，1,000个测验分数或1,000所学校。很好地掌握数据的粒度将有助于您避免不良的分析，并让您确定您是否拥有分析所需的数据。

*查找数据详细程度的一种快速方法是将“* *记录数”**放在“* *文本”**架子上，然后在“* *行”**架子**上尝试不同的尺寸**。**当所有行均显示为**1**并且状态栏左下方显示的总数等于数据中的记录数时，则该维（或维的组合）将***唯一地标识***一条记录，并定义最低级别的详细信息数据。*

了解了有关数据粒度的总体原理之后，我们将继续学习某些数据结构，这些数据结构使您可以在Tableau中无缝高效地工作。有时，最好使用Alteryx或Tableau Prep  Builder之类的工具在源处重构数据。有时，重组源数据是不可能的或不可行的。在这些情况下，我们将看看Tableau中的一些选项。现在，让我们考虑一下哪种数据结构可以与Tableau一起使用。

#### 良好的结构 — 高而窄而不是短而宽 <div id="page_204"></div>

我们在上一节中提到的一个好的结构的两个关键应该导致一个数据结构，其中一个度量包含在单个列中。您可能有多个不同的度量，但是任何单个度量几乎都不应划分为多列。通常，差异被描述为**宽数据与高数据**。

##### 宽数据 <div id="page_205"></div>

**宽数据**描述了一种结构，其中单行中的度量分布在多列中。这些数据通常更*易于阅读*。宽数据通常导致更少的行和更多的列。

这是人口数表中的宽数据外观示例：

| **国家的名字** | **1960年** | **1961年** | **1962年** | **1963年** | **1964年** |
| -------------- | ---------- | ---------- | ---------- | ---------- | ---------- |
| 阿富汗         | 8,774,440  | 8,953,544  | 9,141,783  | 9,339,507  | 9,547,131  |
| 澳大利亚       | 10,276,477 | 10,483,000 | 10,742,000 | 10,950,000 | 11,167,000 |

请注意，此表的详细程度是每个国家/地区的一行。但是，单个度量（填充）未存储在单个列中。该数据之所以广泛，是因为它只有一个度量（人口），被分为多列（每年一列）。宽表违反了良好结构的第二个关键，因为该度量的详细程度低于单个记录（每个国家/每年，而不仅仅是每个国家/地区）。

##### 高数据 <div id="page_206"></div>

**高数据**描述了一种结构，其中行中的每个不同度量都包含在单个列中。高数据通常导致更多的行和更少的列。

考虑下表，该表代表与之前相同的数据，但结构较高：

| **国家的名字** | **年** | **人口**   |
| -------------- | ------ | ---------- |
| 阿富汗         | 1960年 | 8,774,440  |
| 阿富汗         | 1961年 | 8,953,544  |
| 阿富汗         | 1962年 | 9,141,783  |
| 阿富汗         | 1963年 | 9,339,507  |
| 阿富汗         | 1964年 | 9,547,131  |
| 澳大利亚       | 1960年 | 10,276,477 |
| 澳大利亚       | 1961年 | 10,483,000 |
| 澳大利亚       | 1962年 | 10,742,000 |
| 澳大利亚       | 1963年 | 10,950,000 |
| 澳大利亚       | 1964年 | 11,167,000 |

现在，我们有更多行（每个国家/地区每年都有一行）。个别年份不再是单独的列，总体测量也不再分散在这些列中。相反，一个单柱给我们的一个维度**年**和另一单栏给出的度量**人口**。行数增加而列数减少。现在，总体的度量与单个行的详细程度处于同一水平，因此Tableau中的可视化分析将更加容易。

##### 在Tableau中的宽与高 <div id="page_207"></div>

您可以在Tableau中轻松查看宽数据与高数据之间的区别。以下是左侧数据窗口中的**宽**数据**表**：

![img](../images/Image%20[251].jpg)

正如我们期望的那样，Tableau将表中的每一列都视为一个单独的字段。数据的广泛结构不利于我们。我们最终以每年单独的度量标准。如果您想绘制每年的人口折线图，则可能会遇到困难。什么维度代表日期？您可以对人口使用哪种单一度量？

这并不是说您不能在Tableau中使用宽数据。例如，您可以使用度量名称 / 度量值在单个视图中绘制所有**Year**度量，如下所示：

![img](../images/Image%20[252].jpg)

您会注意到，每年字段都放置在Measure Values架子上。好消息是您可以根据结构不良的数据创建可视化文件。坏消息是视图通常很难创建，某些高级功能可能不可用。由于以下原因，在前面的视图中可能会发生这种情况：

- 由于Tableau没有日期维度或整数，因此无法使用预测
- 由于Tableau在Columns上没有日期或连续字段，因此无法启用趋势线
- 因为每个度量都是一个单独的字段，所以您不能使用快速表计算（例如，运行总计，差异百分比等）
- 确定诸如多年平均人口之类的事情将需要繁琐的自定义计算，而不是简单地更改度量的汇总
- 您没有日期轴（度量值名称只有一堆标题），因此您将无法添加参考线

相反，**高数据**在数据窗格中如下所示：

![img](../images/Image%20[253].jpg)

该数据源更容易使用。只有一个度量（“ 人口”）和“ 年份”维度可以对度量进行切片。如果要按年绘制人口折线图，只需将“ 人口和年”字段拖放到“ 列和行”中。预测，趋势线，聚类，平均值，标准差和其他高级功能将按您期望的那样起作用。

#### 良好的结构 — 星型模式（数据集市/数据仓库） <div id="page_208"></div>

假设它们是经过精心设计的，星型模式数据模型与Tableau可以很好地一起工作，因为它们具有明确定义的粒度，度量和维。此外，如果实施得当，它们可以非常有效地进行查询。在Tableau中使用实时连接时，这可以提供良好的体验。

之所以这么**称呼星形模式，**是因为它们由单个事实表组成，并由相关的维表包围，从而形成星形模式。**事实表**包含有意义粒度的度量，而**维度表**包含各种相关实体的属性。下图说明了一个简单的星型方案，其中包含一个事实表（“ **医院就诊”**）和三个维度表（“ **患者”**，“ **主治医师** ”和“ **出院详细信息”**）：

![img](../images/000120.gif)

事实表使用引用单个维记录的通常称为**代理键**或**外键的**方式连接到相关维。事实表定义了粒度级别并包含度量。在这种情况下，“ 医院访问”的粒度为每次访问一个记录。在此简单示例中，每次访问都是针对一位看过一位主治医生并已出院的患者。“ 医院访问”表显式存储“  访问持续时间”的度量，并隐式定义“访问次数”的另一个度量（在本例中为“记录数”）。

*数据建模纯粹主义者会指出日期值已存储在事实表（甚至某些维）中，并且建议使用一个日期维表，该表具有每个日期的广泛属性，并且仅在其中存储一个替代（外键）事实表。*

*日期维度可能非常有益。**但是，Tableau的内置日期层次结构和广泛的日期选项使在事实表中存储日期成为可行的选择。**如果您需要Tableau中不可用的日期的特定属性（例如，哪些日子是公司假期），会计年度复杂，或者需要支持旧版BI报告工具，请考虑使用日期维度。*

设计良好的星型架构允许使用内部联接，因为每个代理键都应引用一个维记录。如果尺寸值未知或不适用，则使用特殊尺寸记录。例如，尚未完成的住院访问（患者仍在医院）可以参考出院明细表中标记为**尚未出院**的特殊记录。在Tableau中连接星型模式时，请从事实表开始，然后添加维度表，如下所示：

![img](../images/Image%20[254].jpg)

结果数据连接（作为示例显示，但未包含在Chapter 09工作簿中）使您可以按表查看尺寸属性。这些度量来自单个事实表：

![img](../images/Image%20[255].jpg)

*良好实现的星形架构特别适合在***实时连接中***使用，**因为Tableau可以通过实现***联接***剔除来提高性能。*

**联接剔除***是Tableau消除查询中不必要的联接的一种方法，因为它会将它们发送到数据源引擎。**例如，如果要**在行**上**放置“* *医师姓名”**，**在“* *列”**上**放置“* *平均**就诊持续时间”**，**以获得每个医生**的平均**就诊持续时间**的条形图，则可以加入“* *治疗**和**患者”**表可能不需要。**只要您使用简单的星形模式，并且联接仅来自中央事实表并在源中启用引用完整性，或者允许Tableau承担引用完整性，Tableau就会消除不必要的联接（从“* *数据”**菜单中**选择数据源连接）**或使用数据源连接中的上下文菜单，然后选择“* *假定参照* *完整性”**。*

考虑了一些结构良好的示例之后，让我们将注意力转向处理结构不良的数据。

### 处理数据结构问题 <div id="page_209"></div>

在某些情况下，在源处重组数据不是一种选择。源可能是安全的且是只读的，或者您甚至可能无法访问原始数据，而是定期接收特定格式的数据。在这种情况下，一旦您连接到Tableau中的数据，便可以使用一些技术来处理结构性问题。

我们将考虑一些数据结构问题的示例，以演示在Tableau中处理这些问题的各种技术。没有一种解决方案是解决给定问题的*唯一正确方法*。通常，有几种方法可能会起作用。此外，这些仅是您可能遇到的问题的示例。花一些时间来了解建议的解决方案如何基于我们在先前各章中已经考虑过的基本原理，以及如何使用类似的技术来解决数据问题。

#### 在Tableau连接中重组数据 <div id="page_210"></div>

Excel工作簿World Population Data.xlsx包含在Data本书随附的资源目录中，它是许多Excel文档的典型代表。看起来是这样的：

![img](../images/000100.gif)

这样的Excel文档通常更易于阅读，但在Tableau中包含多个数据分析问题。此特定文档中的问题包括以下内容：

- 不属于数据的过多标题（标题，注释和格式）
- 合并细胞
- 列中的国家/地区名称和代码
- 可能不必要的列（指标名称和指标代码）
- 数据范围很广，也就是说，每年都有一列，而人口测度分布在单个记录中的这些列中

最初连接到Tableau中的Excel文档时，连接屏幕将类似于以下内容：

![img](../images/Image%20[256].jpg)

数据预览揭示了结构不良导致的一些问题：

- 由于列标题不在第一个Excel行中，因此Tableau 为每个列提供了默认值F1，F2等
- 标题“ 世界人口数据”和有关样本数据的注释被解释为F1列中的值
- 实际的列标题被视为一行数据（第三行）

幸运的是，这些问题可以在连接窗口中解决。首先，我们可以通过打开**Tableau Data Interpreter**来纠正许多过多的标头问题，**Tableau Data Interpreter**是专门识别和解决Excel或Google Sheets文档中常见结构性问题的组件。选中“ 使用数据解释器”选项时，数据预览将显示更好的结果：

![img](../images/Image%20[257].jpg)

*单击**复选框下方显示**的“* *查看结果...”**链接，将使Tableau生成一个新的Excel文档，该文档以颜色进行编码，以指示数据解释器如何解析Excel文档。**使用此功能可以验证Tableau是否正确解释了Excel文档并保留了所需的数据。*

观察到消除了多余的标题和列的正确名称。还有一些其他问题需要纠正。

首先，如果我们认为指标名称和指标代码列对我们的分析无用，则可以将其隐藏。单击列标题上的下拉箭头将显示一个选项菜单。Hide将从连接中删除该字段，甚至阻止将其存储在摘录中：

![img](../images/Image%20[258].jpg)

其次，我们可以使用同一菜单上的选项将“ 国家/地区名称和代码”列分成两列，以便我们可以分别使用名称和代码。在这种情况下，菜单上的“  拆分”选项可以很好地工作，Tableau可以完美地拆分数据，甚至可以删除代码周围的括号。如果分割选项最初不起作用，请尝试“  自定义分割...”选项。我们也将使用重命名...选项来重命名分裂领域Country Name and Code - Split 1和Country Name and Code - Split 2以Country Name和Country Code分别。然后，我们将隐藏原始Country Name and Code字段。

至此，大多数数据结构问题已得到纠正。但是，您会认识到数据的格式很**宽**。我们已经看到了将要遇到的问题：

![img](../images/Image%20[259].jpg)

我们的最后一步是**转动**的**年度**列。这意味着我们将以一种方式重塑数据，以使每个国家/地区每年都有一行。通过单击1960列，滚动到最右边，并在单击2013列的同时按住*Shift*，选择所有年份列。最后，使用任何年份字段上的下拉菜单，然后选择“ 数据透视”选项。

结果是两列（Pivot field names和Pivot field values）代替所有年列。将两个新列重命名为Year和Population。您的数据集现在又窄又高，而不是宽而又短。

最后，从“ **年份”**列上的图标中注意到，Tableau将其识别为文本字段。单击该图标将允许您直接更改数据类型。在这种情况下，选择“ 日期”将得到NULL值，但是将数据类型更改为“ 数字（整个）”将为您提供整数值，该值在大多数情况下都可以正常使用：

![img](../images/Image%20[260].jpg)

*或者，您可以使用**Year**字段**上的第一个下拉菜单，**然后选择**Create Calculated Field ...，**这将允许您创建一个计算字段名称**Year（日期）**，该年份使用诸如的代码将年字符串解析为日期**DATE(DATEPARSE("yyyy", [Year]))**。*

*此代码将解析该字符串，然后将其转换为没有时间的简单日期。**然后，您可以隐藏原始的**Year**字段。**您可以隐藏任何字段，即使该字段用于计算中也是如此，只要该字段未在视图中使用即可。**这为您提供了一个非常干净的数据集。*

与原始数据集相比，最终数据集在Tableau中的使用要容易得多：

![img](../images/Image%20[261].jpg)

#### 将文件合并在一起 <div id="page_211"></div>

通常，您可能有多个单独的文件或表，它们一起代表了整个数据集。例如，您可能具有一个在特定目录中创建新的每月数据转储作为新文本文件的过程。或者，您可能有一个Excel文件，其中每个部门的数据都包含在单独的工作表中。

甲**联盟**是汇集了各表的行成单个数据源的数据表的串联。例如，考虑以下三个数据表：

**原稿：**

| **名称** | **占用** | **银行账户余额** |
| -------- | -------- | ---------------- |
| 路加     | 农民     | $ 2,000          |
| 莉亚     | 公主     | $ 50,000         |
| 韩       | 走私者   | -$ 20,000        |

**前传：**

| **名称**  | **占用**   | **银行账户余额** |
| --------- | ---------- | ---------------- |
| 瓦托      | 垃圾交易商 | $ 9,000          |
| 达斯·莫尔 | 脸画家     | $ 10,000         |
| 罐子      | 西斯领主   | -$ 100,000       |

**续集：**

| **名称** | **占用** | **银行账户余额** |
| -------- | -------- | ---------------- |
| 雷伊     | 清道夫   | $ 600            |
| 坡       | 飞行员   | $ 30,000         |
| 凯洛     | 待业     | $ 0              |

这些表的并集将给出一个包含每个单独表的行的表：

| **名称**  | **占用**   | **银行账户余额** |
| --------- | ---------- | ---------------- |
| 路加      | 农民       | $ 2,000          |
| 莉亚      | 公主       | $ 50,000         |
| 韩        | 走私者     | -$ 20,000        |
| 瓦托      | 垃圾交易商 | $ 9,000          |
| 达斯·莫尔 | 脸画家     | $ 10,000         |
| 罐子      | 西斯领主   | -$ 100,000       |
| 雷伊      | 清道夫     | $ 600            |
| 坡        | 飞行员     | $ 30,000         |
| 凯洛      | 待业       | $ 0              |

通过Tableau，可以将基于文件的数据源中的表合并在一起，包括以下内容：

- 文本文件（.csv，.txt和其他文本文件格式）
- Excel文档中的工作表（标签）
- Excel工作表中的子表
- 多个Excel文档
- Google表格
- 关系数据库表

*使用***数据解释器***功能可在Excel或Google表格中查找子表。**它们将显示为左侧边栏中的其他数据表。*

要在Tableau中创建联合，请按照下列步骤操作：

1. 从菜单，工具栏或“ 数据源”屏幕创建一个新的数据源，从您希望成为联合的文件之一开始。然后，将所有其他文件拖放到设计器中现有表下方的“ 将表拖放到并集”拖放区中：

![img](../images/Image%20[262].jpg)

1. 创建联合后，可以使用设计器中表格上的下拉菜单来配置联合选项。或者，您可以将 New Union 对象从左侧边栏拖到设计器中以替换现有表。这将显示用于创建和配置联合的选项：

![img](../images/Image%20[263].jpg)

“ 特定（手动）”选项卡允许您将表拖入或拖出并集。该通配符（自动）选项卡允许您指定的文件名和表（Excel文件和谷歌表）通配符，将自动包含在基于通配符匹配工会的文件和图纸。

*如果您预计将来会添加其他文件，**请使用**通配符（自动）**功能。**例如，如果您有一个特定目录，该目录会定期转储数据文件，那么通配符功能将确保您不必手动编辑连接。*

1. 一旦定义了并集，就可以使用结果数据源来可视化数据。此外，联合表可以与设计器窗口中的其他表结合在一起，为您提供处理数据时的很大灵活性：

*在联合中，Tableau将按名称匹配表之间的列。**一个文件/表中存在但其他**NULL**文件中不存在的列**将显示为联合表的一部分，但值将出现**在该列/文件不存在的文件/表中。**例如，如果文件之一包含一个名为***Job***的列**而不是***Occupation***，则最终的联合表将包含一个名为***Job***的列**和另一个名为***Occupation***NULL**的列**，其**值不存在该列。**您可以通过选择列并使用下拉菜单来合并不匹配的列。**这将***合并***（保留第一个非空值）单个新列中每行数据的值。*

![img](../images/Image%20[264].jpg)

创建联合时，Tableau将在数据源中包括一个或多个新字段，以帮助您识别数据的来源文件，工作表和表格。路径将包含文件路径（包括文件名），工作表将包含工作表名称（对于Excel或Google表格），表名称将包含子表或文本文件名。您可以使用这些字段来帮助您识别数据问题，并根据需要扩展数据集。例如，如果你有月度数据的目录转储命名的文件2018-01.txt，2018-02.txt，2018-03.txt，等等，但在文件中没有实际的日期字段，你可以得到使用之日起计算的与代码申请，如以下情况：

DATEPARSE（'yyyy-MM'，[表名]）

#### 跨数据库联接 <div id="page_212"></div>

Tableau使您能够跨数据连接联接数据。这意味着您可以联接来自完全不同的数据库和文件格式的数据表。例如，您可以在SQL Server中将表与文本文件的并集连接起来，然后将它们连接到Google表格文档中。

你会记得的概念连接和跨数据库的具体联接是在介绍[第2章](docs/Book.md#page_43)，*工作与数据中的Tableau*。尽管跨数据库联接对于将**不同的数据**源（包含在不同系统和格式中的数据）组合在一起非常有用，但是它们也可以用于解决其他数据问题，例如重塑数据以使其更轻松地满足Tableau中的目标。

*您可以在**Chapter 9**工作簿中**完成以下示例**，但是服务器数据库数据源是使用文本文件（**Patient Visits.txt**）**模拟的**。*

##### 一个实际的例子 — 填写缺少/稀疏的日期 <div id="page_213"></div>

假设您在服务器数据库（例如SQL Server或Oracle）中有一个表，该表每名住院患者包含一行，并且将“入院**日期”**和“ **出院日期”**作为每位患者的单独列：

![img](../images/000046.gif)

尽管此数据结构对于某些类型的分析非常有效，但是如果要直观显示12月份医院的每日患者数量，将会发现很难使用。

例如，您将哪个日期字段用作轴？即使您旋转表以使所有日期都集中在一个字段中，您也会发现数据中存在空白。**稀疏数据**（即对于某些值不存在记录的数据）在某些实际数据源中非常普遍。具体来说，在这种情况下，每个入学或出院日期只有一条记录，而中间没有记录。

有时，在源处重组数据可能是一种选择，但是如果数据库已锁定，则您可能没有该选择。您也可以使用Tableau的功能来填补数据中的空白（**数据密集化**）以解决问题。但是，该解决方案可能很复杂，并且可能很脆弱或难以维护。

一种替代方法是使用跨数据库联接为所有日期创建行。因此，您可以快速创建一个Excel工作表，其中包含要查看的日期列表，如下所示：

![img](../images/000223.gif)

Excel文件包含每个日期的记录。我们的目标是在数据库表和Excel表之间**交叉联接**（联接一个表中的每一行与另一表中的每一行）。完成此操作后，您将在每个日期为每个患者安排一行。

*将一个数据集中的每条记录与另一数据集中的每条记录连接在一起，就可以创建***笛卡尔乘积***。**结果数据集将具有N1 \* N2行（其中N1是第一个数据集中的行数，N2是第二个数据集中的行数）。**使用这种方法时要小心。**它适用于较小的数据集。**当您使用更大的数据集时，笛卡尔积可能会变得很大，以至于站不住脚。*

通常，您会在各个表中都有特定的字段，这些字段使您可以将数据连接在一起。但是，在这种情况下，我们没有任何定义联接的键。日期也不能使我们以一种可以为我们提供所需结构的方式来联接所有数据。为了实现交叉联接，我们将使用联接计算。一个**加入计算**可以专门写一个特殊的计算字段用于连接。

在这种情况下，我们将为两个表都选择Create Join Calculation ...，并1为左侧和右侧输入一个单独的硬编码值，即 ：

![img](../images/Image%20[265].jpg)

由于1左侧1的每一行都与右侧的每一行都匹配，因此我们得到的每一行都与每一行匹配，这是真正的交叉联接。

*作为替代方案，对于许多其他基于服务器的数据源，可以将“* **自定义SQL”***用作数据源。**在“* *数据源”**屏幕上，使用设计器中的“* *患者就诊”**表，可以使用顶部菜单选择“* *数据”* *|“* *数据”**。**转换为自定义SQL**以编辑Tableau用于源的SQL脚本。**或者，您可以使用**左侧栏中**的“* *新建自定义SQL”**对象**编写自己的自**定义SQL**。*

此替代示例中的脚本已被修改为包括 1 AS Join 创建一个名为 **Join** 的字段，每行的值为1。自定义SQL中定义的字段也可以在联接中使用：

![img](../images/Image%20[266].jpg)

基于联接计算，我们新的交叉联接数据集包含每个日期每个患者的记录，我们现在可以创建一个快速计算，以查看在任何给定日期是否应将患者算作医院人口的一部分。计算的字段名为Patients in Hospital，具有以下代码：

如果[录取日期] <= [日期]并且[出院日期]> = [日期]

然后1

其他0

结束

这使我们能够轻松地可视化患者的流向，甚至有可能基于平均值，趋势甚至预测来执行高级分析：

![img](../images/Image%20[267].jpg)

最终，对于长期解决方案，您可能需要考虑开发基于服务器的数据源，该数据源提供所需分析所需的结构。但是，跨数据库联接使我们无需等待较长的开发周期即可完成分析。

#### 处理不同级别的细节 <div id="page_214"></div>

请记住，good的两个关键如下：

- 具有有意义的细节水平
- 具有与详细程度相匹配的度量，或者可能具有更高的详细程度

较低级别的度量往往会导致获得宽数据，并且可能使某些分析变得困难甚至无法进行。有时，更高细节级别的措施可能会有用。只要我们知道如何正确处理它们，就可以避免一些陷阱。

例如，考虑以下数据（包含Apartment Rent.xlsx在Chapter 9目录中），这些数据为我们每个公寓每月提供一个记录：

![img](../images/Image%20[268].jpg)

这两项措施的详细程度确实不同：

- **收集的租金**与数据的详细程度相匹配，其中记录了每个公寓每个月收取了多少租金。
- 另一方面，**平方英尺**不会逐月变化。而是仅在较高的公寓级别。

当我们从视图中删除日期并查看公寓级别的所有内容时，可以观察到这一点：

![img](../images/Image%20[269].jpg)

注意，这Sum(Rent Collected)是很有意义的。您可以合计每月收取的租金，并获得每间公寓有意义的结果。但是，您无法Sum上班Square Feet并获得每间公寓有意义的结果。其他汇总，例如平均值，最小值和最大值，确实可以为每个公寓提供正确的结果。

但是，假设您被要求提出收取的总租金与每套公寓平方英尺的比率。您知道这将是一个汇总计算，因为您必须对除以之前收集的租金进行汇总。但是，其中哪一项是正确的计算？

- SUM([Rent Collected])/SUM([Square Feet])
- SUM([Rent Collected])/AVG([Square Feet])
- SUM([Rent Collected])/MIN([Square Feet])
- SUM([Rent Collected])/MAX([Square Feet])

第一个显然是错误的。我们已经看到不应每月增加平方英尺。如果我们确保**Apartment**继续定义视图的细节级别，则最后三个中的任何一个都是正确的。

但是，一旦我们查看了具有不同细节级别的视图（例如，所有公寓的总数或多套公寓的每月视图），则该计算将不起作用。要了解原因，请考虑打开列总计的情况（从菜单中选择“ 分析” |“ 总计” |“ 显示列总计”或从“ 分析”选项卡中拖放“ 总计 ” ）：

![img](../images/Image%20[270].jpg)

这里的问题是，总计总数线位于所有公寓（所有月份）的详细信息级别。我们真正想要的平方英尺总数是900 + 750 = **1,650**。但是这里的平方英尺总和是所有月份所有公寓的平方英尺总和。平均水平是行不通的。最小值找到值750，作为数据中所有公寓的最小度量。同样，最大值选择900作为单个最大值。因此，任何提议的计算都无法在不包含单个公寓的任何细节级别上发挥作用。

*您可以通过单击单个值并使用下拉菜单选择如何计算总计来调整小计和总计的计算方式。**或者，右键单击活动的度量字段，然后选择**总计使用**。**您可以通过选择**分析* *|* *从菜单中一次更改所有度量的总计方式。**总计* *|* *总计全部使用中**。**在前面的视图中，**使用这种***两次通过总***技术可能会得到正确的结果，但不能普遍解决该问题。**例如，如果您想显示每月的每平方英尺价格，则会遇到相同的问题。*

幸运的是，Tableau使我们能够在视图中处理不同级别的细节。使用**详细等级**（**LOD**）计算，这在我们以前遇到的[第4章](docs/Book.md#page_96)， *开始了冒险与计算*，我们可以每间公寓计算平方英尺。

在这里，我们将使用固定的LOD计算来保持公寓的固定细节级别。我们将创建一个Square Feet per Apartment使用以下代码命名的计算字段：

{包括[公寓]：MIN（[方脚]）}

花括号包围着LOD计算，并且关键字INCLUDE表示我们希望将**Apartment**包括在计算的细节级别中，即使它不在细节视图级别中也是如此。MIN可以在前面的代码中使用，但MAX也AVG可以使用，因为每个单元的结果相同。

如您所见，该计算在单元级别和总计级别的视图中返回正确的结果，其中Tableau包含要查找**900**（**A**的最小值）和**750**（**B**的最小值）的**Apartment**，然后对其求和得到**1,650**：

![img](../images/Image%20[271].jpg)

现在，我们可以在其他计算中使用LOD计算字段来确定所需的结果。我们将创建一个Rent Collected per Square Foot使用以下代码命名的计算字段：

总和（[已出租]）/总和（[每间公寓的平方英尺]

当将该字段添加到视图并设置格式以显示小数时，最终结果是正确的：

![img](../images/Image%20[272].jpg)

*或者，**INCLUDE**我们可以使用***FIXED***的细节级别**，而不是使用**，**它总是在**FIXED**关键字**后面的维度的细节级别执行**，而不管视图中定义了什么细节级别。**这将使Tableau始终计算每间公寓的最小平方英尺，而不管定义细节视图级别的尺寸如何。**尽管非常有用，但是请注意，**FIXED**详细程度计算是针对整个上下文（整个数据集或***上下文过滤器***定义的子集**）计算的。**在不理解的情况下使用它们可能会产生意外的结果。*

### 数据问题高级修复概述 <div id="page_215"></div>

除了本章前面提到的技术之外，还有一些其他可能性可以处理数据结构问题。完全开发这些概念超出了本书的范围。但是，通过对这些方法有所了解，您可以扩大应对挑战的能力：

- 可以在数据连接中使用**自定义SQL**来解决一些数据问题。如前所述，除了为跨数据库联接提供字段外，自定义SQL还可用于彻底重塑从源检索到的数据。自定义SQL并不是所有数据源的选项，而是许多关系数据库的选项。考虑一个自定义SQL脚本，该脚本采用了本章前面提到的广泛的国家/地区表，并将其重组为一个高表：

SELECT [国家名称]，[1960] AS人口，1960 AS年份

来自国家

全联盟

SELECT [国家名称]，[1961] AS人口，1961 AS年

来自国家

全联盟

SELECT [国家名称]，[1962] AS人口，1962 AS年

来自国家

...

...

等等。设置起来可能有些繁琐，但是它将使数据在Tableau中更容易使用！但是，出于性能原因，将需要提取许多使用复杂的自定义SQL的数据源。

- **工会**：Tableau的能力，工会的数据源，如Excel，文本文件，和谷歌表可以以类似于自定义SQL实例来重塑数据转换成高大的数据集的方式使用。您甚至可以将相同的文件或工作表合并到其自身。在某些可视化需要多个记录的情况下，这很有用。例如，使用具有源和目标列的单个记录很难（或不可能）显示从源到目标的路径。但是，将数据集还原成其自身会产生两行：可以可视化为源，另一行可视为目标。
- **表格计算**：表格计算可用于解决从查找和消除重复记录到处理多个详细信息级别的许多数据难题。由于表计算可以在更高详细级别的分区中工作，因此可以将多个表计算和聚合计算一起使用，以在单个视图中混合详细级别。一个简单的示例就是“总计百分比”表计算，该表将视图中详细级别的汇总计算与更高详细级别的总计进行比较。
- **数据混合**：数据混合可用于解决许多数据结构问题。因为您可以定义使用的链接字段，所以您可以控制混合的详细程度。例如，我们研究的公寓租金数据问题可以通过第二个来源来解决，该来源每个平方英尺的记录都只有一个记录。在公寓级别进行融合将使您获得所需的结果。
- **数据支架**：数据支架扩展了数据混合的概念。使用这种方法，您可以构建各种尺寸值的支架以用作主要来源，然后混合到一个或多个次要来源。这样，您可以控制主要来源的结构和粒度，同时仍然能够利用次要来源中包含的数据。

### 总结 <div id="page_216"></div>

在本章之前，我们主要研究结构合理且易于使用的数据。在本章中，我们考虑了什么构成良好的结构以及处理不良数据结构的方法。一个好的结构由具有有意义的详细程度并具有与该详细程度相匹配的度量的数据组成。当度量分布在多列中时，我们得到的是**宽**数据而不是**高数据**。

现在，您已经拥有运用各种技术来处理形状错误或细节级别错误的数据的经验。Tableau为我们提供了解决其中一些结构性问题的能力和灵活性，但是，最好在源头修复数据结构。

在下一章中，我们将暂停一下Tableau Desktop，以考虑解决挑战性数据的另一种方法– **Tableau Prep**！

## 第十章 介绍Tableau Prep <div id="page_217"></div>

在上一章中，我们考虑了一些在Tableau Desktop中构造数据的选项。关于结构化数据的许多概念都将在此处应用，因为我们现在将注意力转向Tableau的全新产品：**Tableau Prep**。Tableau Prep扩展了Tableau平台，提供了健壮的选项，可用于清洁和结构化Tableau中的分析数据。与Tableau  Desktop提供用于可视化和分析数据的动手视觉体验相同，Tableau Prep也提供了用于清洁和整形数据的动手视觉体验。

Tableau  Prep处于每月加速的发布周期，并且在平台继续增长和扩展的同时，存在一个基本的范例，为清理和整形数据奠定了基础。在本章中，我们将介绍很多基础知识。但是，我们的目标不是涵盖所有可能的功能。而是，我们将寻求了解潜在的范例和思想流程，使您能够应对Tableau Prep中的大量数据挑战。

在本章中，我们将通过一个实践示例来研究Tableau Prep的范例，了解基本转换，并了解Tableau Prep的许多特性和功能。

本章将涵盖很多主题，包括：

- 了解Tableau Prep Builder界面
- 顺应基本范式
- 使用计算和汇总
- 筛选数据
- 转换数据以进行自定义分析
- 流程自动化选项

*在本章中，我们将**广义地**使用术语* **Tableau Prep** *来表达Tableau为数据准备而开发的整个平台，有时还可以用作Tableau Prep Builder的简写，Tableau Prep Builder是用于连接数据，创建数据流和定义输出。**为了清楚起见，我们将使用以下特定名称：*

- **Tableau Prep Builder***：用于设计数据流，在本地运行它们并发布它们的客户端应用程序*
- **Tableau Prep Conductor***：Tableau Server的附加组件，用于调度和自动化已发布的数据流*

### 准备探索Tableau Prep <div id="page_218"></div>

**Tableau Prep Builder**可用于Windows和Mac。如果您当前尚未在计算机上安装Tableau Prep Builder，请花一点时间从<https://www.tableau.com/products/prep/download下载该应用程序。Tableau> Creator许可中包括Tableau Prep Builder的许可。如果您当前没有许可证，则可以试用该应用程序14天。请与您的Tableau代表交谈以确认许可和试用期。

本章中的示例使用目录中的\Learning Tableau\Chapter 10文件。具体说明将指导您何时以及如何使用各种文件。

### 了解Tableau Prep Builder界面 <div id="page_219"></div>

在Tableau Prep Builder和Tableau Desktop的界面中会发现很多相似之处。Tableau Prep Builder的主屏幕将类似于以下内容：

![img](../images/Image%20[273].jpg)

以下屏幕快照中已对以下组件进行编号：

1. 该菜单包括用于打开文件，编辑和运行流，登录Tableau Server以及各种**帮助**功能的选项。
2. 顶部的两个大按钮使您可以选择打开流程以打开现有作品，或选择连接到数据以使用初始数据连接来启动新流程。我们将在下一部分中定义一个流程。现在，以Tableau Prep等效于Tableau Desktop工作簿的方式考虑流程。
3. 最近的流程显示您最近保存的Tableau Prep数据流。您可以单击其中之一打开流程并进行编辑或运行。右侧的切换按钮可让您在缩略图和列表之间切换。
4. Sample Flows使您可以打开一些预构建的示例。
5. “ 连接”窗格以**+**按钮开头，可让您添加新的数据连接。添加连接时，这些连接以及相关的表，视图，文件和其他选项将在此窗格中列出。
6. 当您了解有关Tableau Prep的更多信息时，“ 发现”窗格为您提供了培训和资源的选项。

打开或启动新流程后，主屏幕将替换为新界面，该界面将有助于设计和运行流程：

![img](../images/Image%20[274].jpg)

该界面包含以下内容，这些内容在前面的屏幕快照中已编号：

1. 该**流程窗格**，在那里你会在逻辑上建立数据流与步骤，这将从清洁到计算，转型和重塑做任何事情。选择任何单个步骤将显示该步骤特定的其余界面。
2. “ 更改”窗格列出了该步骤中所做的所有更改，从计算到重命名或删除字段，再到更改数据类型或分组值。
3. 该**资料窗格**让你在步骤每个字段的轮廓。您可以看到每个字段的值的类型和分布。单击一个字段将突出显示流程窗格中的沿袭，使用笔刷单击一个或多个字段的值将突出显示其他字段的相关值。
4. 该**数据网格**显示数据的单个记录，因为他们在这一步存在。在“ **更改”**网格中选择一个更改将显示基于直至（包括）所选更改的更改的数据。在配置文件窗格中选择一个值将过滤数据网格以仅显示包含该值的记录。例如，在配置文件窗格中的“ 运送模式”字段中选择“ 第一类 ” 将对数据网格进行过滤，以仅显示“ 第一类运送模式”的记录。这使您可以浏览数据，但是只有执行特定操作才能导致更改，然后才能更改数据。

您还将注意到工具栏，该工具栏允许您撤消或重做操作，刷新数据或运行流。此外，还会根据所选步骤或字段的类型显示其他选项或控件。稍后我们将深入研究范式和实际示例时，将考虑这些细节。

### 顺应基本范式 <div id="page_220"></div>

Tableau Prep的整体范例是通过流程发现，清理和整形数据的动手式视觉体验。甲**流**（有时也被称为**数据流**）是一个逻辑一系列被从输入端（S）施加到数据输出（多个）步骤和变化。在Tableau Prep的流程窗格中，流程如下所示：

![img](../images/Image%20[275].jpg)

该流程的每个单独组成部分都称为“ **步骤”**，这些**步骤**由指示数据的逻辑流程（从左到右）的线连接起来。这些线称为流的**连接器**或**分支**。请注意，此处的“ 聚合步骤”有一个连接器从左侧进入，三个分支向右侧延伸。任何步骤都可以具有多个输出分支，并且流的每个分支可以终止于单独的输出，或者可以随后合并或合并回该流的另一部分。

在通读本章中的流程示例时，我们将更仔细地研究每种步骤。现在，请考虑Tableau Prep中主要步骤的以下初步定义：

- **输入步骤**：输入步骤从文件，表，视图或自定义SQL的数据开始流程。它提供了用于定义文件定界符，多个表或文件的并集以及要采样的数据量（对于较大的记录集）的选项。

- **清理步骤**：清理步骤使您可以对数据执行多种功能，包括计算，过滤，调整数据类型，删除和合并字段，分组和清理等等。

- **总结步**：一个聚合步骤允许您汇总值（例如，获取MIN，MAX，SUM，AVG）在细节层次指定。

- **连接步骤**：连接步骤使您可以将流的两个分支放在一起，它们代表可以在一个或多个关键字段上连接的数据集。您将具有用于选择连接类型以及连接字段的选项。

- 合并**步骤**：合并步骤使您可以将两个或多个代表要合并在一起的数据集的分支放在一起。您将具有用于合并或删除不匹配字段的选项。

  *在此示例中**，“* *联合步骤”**和“* *加入步骤”**都具有错误图标，指示在流程中未正确配置某些内容。**将鼠标悬停在图标上会提供错误的工具提示说明。**在这种情况下，错误是由于只有一个输入连接而引起的，而联合和联接都需要至少两个输入。**通常，选择带有错误图标的步骤可能会在“* **更改”***窗格或配置步骤中的其他位置**显示有关错误的详细信息**。*

- **枢轴步骤**：枢轴步骤使您可以将数据列转换为行或将数据行转换为列。您将具有选择枢轴类型以及字段本身的选项。有时，您可能会听到术语“转置”代替“透视”。

- **输出步骤**：输出步骤定义了清理和转换后的数据的最终目标。这可以是文本文件（.csv），提取（.hyper或.tde），也可以是将提取的数据源发布到Tableau Server。您将具有选择输出类型的选项，以及路径和文件名或Tableau Server和项目。

*右键单击步骤或连接器将显示各种选项。**您也可以将步骤拖放到其他步骤上以显示选项，例如将步骤结合或结合在一起。**如果要替换流程的早期部分以换出输入步骤，则可以右键单击连接器并选择**Remove**，然后将新的输入步骤拖到流程中所需的下一步上，以将其添加为新的步骤。输入。*

除了使用术语“ *流”*来指代定义逻辑流和数据转换的步骤和连接之外，我们还将使用术语“ *流”*来指代Tableau Prep用来存储步骤和步骤定义的文件。流的变化。Tableau Prep流文件具有.tfl（**未打包流**）或.tflx（**打包流**）扩展名。

Tableau Prep的范例远远超出了任何单个步骤的功能。在构建和修改流程时，您将收到即时反馈，以便您可以看到每个步骤和更改的影响。这使得迭代发现数据并进行必要的更改相对容易（而且很有趣！）。

*在构建流程，添加步骤，进行更改以及与数据交互时，您将处于***设计模式***。**Tableau Prep将Hyper引擎的缓存与数据库的直接查询结合使用，以在您进行更改时提供近乎即时的反馈。**运行流时，您正在使用***批处理模式***。**Tableau Prep将运行优化的查询和操作，这些查询和操作可能与在设计模式下运行的查询稍有不同。*

在本章的其余部分中，我们将考虑一个示例，以帮助我们讨论Tableau Prep范例并突出一些重要的功能和注意事项。该示例将有机地展开，这将使我们看到Tableau  Prep如何为您提供令人难以置信的灵活性，以应对出现的数据挑战并在发现数据的新方面时进行更改。

我们将让您担任组织的分析师角色，以分析员工的航空旅行。这将包括机票价格，航空公司，甚至是行程本身的一些地理空间分析。需要从多个系统整合数据，并且需要进行一些清理和整形以进行分析。

开放**的Tableau准备生成器**，去家里画面' w ^ e'll开始通过连接到一些数据！

#### 连接数据 <div id="page_221"></div>

在Tableau Prep中连接数据与在Tableau Desktop中连接数据非常相似。在主屏幕上，您可以单击“ 连接到数据”或展开的“ 连接”窗格上的**+** 按钮：

![img](../images/Image%20[276].jpg)

*与Tableau Desktop一样，对于基于文件的数据源，您可以将文件从***Windows资源管理器***或***Finder***拖到Tableau Prep窗口中，以快速创建连接。*

Tableau Prep支持数十种文件类型和数据库，并且列表继续增长。您将认识到Tableau Desktop中存在的许多相同类型的连接可能性。但是，在编写本书时，Tableau Prep不支持Tableau Desktop中可用的所有连接。

您可以创建任意数量的连接，并且“ **连接”**窗格将分别列出每个连接以及任何关联的文件，表，视图和存储过程，或者适用于该数据源的其他选项。您将能够在流中使用数据源的任何组合。

现在，让我们从以下步骤开始我们的示例：

1. 单击“ 连接到数据”。
2. 从显示的可能连接的扩展列表中，选择Microsoft Excel。
3. 您将看到一个名为Employee Flights的主表和一个名为Employee Flights Table 1的子表。将Employee Flights表拖到**Profile**窗格中。将创建一个输入步骤，为您提供数据和其他选项的预览。
4. 输入步骤显示一个字段网格和这些字段的选项。您会注意到，Employee Flights表中的许多字段都被命名为F2，F3，F4，依此类推。这是由于Excel文件的格式，该文件具有合并的单元格和摘要子表。选中“ 连接”窗格上的“ 使用数据解释器”选项，Tableau Prep将正确解析文件。它看起来应该像这样：

![img](../images/Image%20[277].jpg)

选择输入步骤时，Tableau Prep将显示数据中的字段网格。您可以使用网格来取消选中您不希望包括的任何字段，通过单击相关符号来编辑数据类型（例如，将字符串更改为日期），并通过双击字段来编辑字段名称本身名称值。

*如果Tableau Prep Builder检测到数据源包含大量记录，则可能会打开数据采样。***数据采样***使用较小的记录子集，以在设计模式下提供快速反馈和配置文件。**但是，当您以批处理模式运行整个流时，它将使用全部数据集。**您可以控制数据通过点击选择采样**数据采样**的输入窗格。**如果***数据采样***出现在流中的任何地方，**您将收到一个***数据采样***指示符**。*

现在，我们将继续探索数据并解决一些问题。

1. 将鼠标悬停在“ 员工飞行”输入步骤上时，单击出现的**+**按钮。这将通过添加一个称为Clean 1的清洁步骤来扩展流程。

2. 花一点时间使用“ **配置文件”**窗格浏览数据。观察在配置文件窗格中为字段选择单个值如何突出显示其他字段的相关值的一部分。这可以让您深入了解自己的数据，例如根据票证类型查看不同的价格范围：

![img](../images/Image%20[278].jpg)

在“ **纵断面”**窗格中跨字段突出显示条形段，这是由于选择了一个字段值而导致的，这称为**brushing**。您还可以通过配置文件窗格顶部的工具栏或右键单击字段值来对选定的值执行操作。这些操作包括过滤，编辑值或替换为null。但是，在进行任何更改或清除任何数据之前，让我们连接一些其他数据。

事实证明，大多数机票预订数据都在一个由Excel文件表示的数据库中，而另一家航空公司的预订数据则存储在定期添加到目录的文件中。这些文件在\Learning Tableau\Chapter 10\目录中。这些文件以惯例命名Southwest YYYY.csv（其中YYYY表示年份）。

我们将连接到所有现有文件，并确保为将来的其他文件做准备：

1. 单击“ 连接”窗格上的**+**图标，将新连接添加到文本文件。
2. 导航到\Learning Tableau\Chapter 10\目录并选择任何文件以启动连接。查看“ 输入”设置，您应该看到Tableau Prep正确标识了字段分隔符，字段名称和类型：Southwest *YYYY*.csv

![img](../images/Image%20[279].jpg)

1. 在“ 输入”窗格中，选择“ 多个文件”选项卡，然后从“ 单个表”切换到“ 通配符并集”。将匹配模式设置为Southwest*，然后单击应用。这告诉Tableau Prep Southwest合并目录中所有以在一起开头的文本文件：

![img](../images/Image%20[280].jpg)

1. 使用流程窗格中“ 西南”输入步骤上的**+**图标添加一个新步骤。默认情况下，此步骤将命名为Clean 2。再次探索数据，但是在将两个源合并到流中之前，不要采取任何措施。您可能会在“ 清理2” 步骤中注意到一个称为“ 文件路径”的新字段，该字段用通配符联合中适用文件的名称标记每个记录。

#### 清理数据 <div id="page_222"></div>

构造流程的过程非常反复，您经常会发现有关数据的信息，这将有助于您清理和转换数据。为了参考起见，我们将这个示例分成几部分，但不要让这偏离建立流程应该是*思想流程的想法*。该示例是无缝的！

##### 合并，合并不匹配的字段并删除不必要的字段 <div id="page_223"></div>

我们知道我们希望将所有航空公司的预订数据汇总在一起，因此我们将流程中的两条路径结合在一起：

1. 将“ 清洁2”步骤拖到“ 清洁1”步骤上，然后将其拖放到出现的“ **联合”**框中。这将创建一个新的Union步骤，其中包含来自两个干净步骤的输入连接：

![img](../images/Image%20[281].jpg)

1. 该联盟面板，以显示当了联盟选择一步会告诉你错配的领域，指示相关的输入，并给你删除或合并域选项。例如，“ 票价类型”和“ 机票类型”在Excel文件和文本文件中的命名不同，但是指示相同的数据。按住*Ctrl*键，然后选择两个字段。然后，从窗格顶部的工具栏或右键单击菜单中选择“ 合并字段”：

![img](../images/000212.gif)

1. 另外，合并Row ID和Row_ID。
2. 文件路径仅适用Southwest于在“ 输入”步骤中合并在一起的文件。尽管此自动生成的字段有时可能非常有用，但在此示例中它不会向数据添加任何内容。选择字段，然后从菜单中单击“ 删除字段 ”。
3. 同样，旅游保险？和乘客ID仅适用于其中一种输入，在我们的分析中将很少使用。还要删除这些字段。
4. 剩下的单个不匹配字段Airline很有用。现在将其保留，并在流程窗格中的“并集1”步骤上单击**+**图标，然后通过选择“ 添加步骤”来扩展流程。此时，您的流程应如下所示：

![img](../images/000165.gif)

*流程中**“* *联合1”**步骤**上方有一个图标**，指示在此步骤中所做的更改。**在这种情况下，更改是删除了几个字段。**进行更改的每个步骤都将具有相似的图标，当您将鼠标悬停在它们上时，它们将显示工具提示详细信息，并允许您与更改进行交互。**通过单击步骤并打开“* *更改”**窗格**，可以查看更改的完整列表，对其进行编辑，对其进行重新排序以及将其删除**。**根据步骤类型，**可以通过展开或选择“* *更改”**选项卡**来使用**“* *更改”**窗格**。*

##### 分组和清洁 <div id="page_224"></div>

现在，我们将花费一些时间来清理来自两个输入源的数据。选择“ 清理3”步骤后，使用“ **配置文件”**窗格检查数据并继续我们的流程。前两个字段指示一些需要解决的问题：

![img](../images/Image%20[282].jpg)

的表名称被的Tableau制备产生的场作为其一部分联盟1，以指示记录的源。该航空公司外地赶来只从Excel文件（你可以在个人资料窗格中选择它，并观察在流动面板领域的突出路径证实了这一点）。单击“ 航空公司”的空值，然后观察刷牙情况：这可以证明“  航空公司”中的值全部来自西南航空公司文件，因为这些文件不包含表示航空公司的字段。我们将处理这些值并进行一些其他清理：NULLNULL

1. 双击空值，然后键入Southwest以替换NULL为您知道代表正确航空公司的值。Tableau Prep将使用回形针图标指示发生了**分组和替换**操作。

1. 我们将进行其他分组以清理**American**的变体。使用“ 航空公司”字段上的“ **选项”**按钮，选择“ 分组并替换” |“ 替换”。发音：

![img](../images/Image%20[283].jpg)

几乎所有的变化都归为美国 价值。仅保留AA。

1. 在出现的“ 分组和替换”窗格中，*按住Ctrl*并单击“ AA和American”，然后选择“ 组值”：

![img](../images/Image%20[284].jpg)

1. 接下来，选择不再需要的“ 表名”字段。使用工具栏选项，右键单击该字段的菜单或使用选项按钮，选择“ 删除字段”。
2. “配置文件”窗格中的某些字段在右上角具有“ 建议”图标。单击此作为“ 乘客电子邮件”，然后应用建议以分配电子邮件的数据角色：

![img](../images/Image%20[285].jpg)

**数据角色***使您可以根据期望的值的模式或范围快速识别有效或无效值。**分配数据角色后，您可能会收到其他建议，以筛选或替换无效值。*

1. 再次单击“ 建议”按钮，然后将该选项应用到“ 分组和替换无效值” NULL。
2. 其余大多数字段看起来都不错，但票价类型除外，其中包含值1st Class和First Class。选择这两个值，然后将它们与First Class值组合在一起。
3. 至此，我们有了一个包含所有主要数据的干净数据集。我们已经可以做很多分析了。实际上，让我们花点时间预览数据。右键单击Clean 3步骤，然后选择Tableau Desktop中的Preview：

![img](../images/Image%20[286].jpg)

将建立新的数据连接并在Tableau Desktop中打开。您可以预览流程中任何步骤的数据。花一些时间在Tableau Desktop中浏览数据，然后返回Tableau Prep。现在，我们将注意力转向通过一些计算，补充数据和一些重组来扩展数据集。

#### Tableau Prep中的计算和聚合 <div id="page_225"></div>

Tableau Prep中的计算遵循的语法几乎与Tableau Desktop相同。但是，您会注意到只有行级函数可用。这是因为Tableau Prep中的所有计算都是在行级别完成的。聚合是通过一个**聚合步骤**执行的，稍后我们将介绍该**步骤**。

计算和聚合可以大大扩展我们的分析能力。在我们当前的示例中，有机会分析购票与实际旅行之间的时间长度。我们可能还希望在每条记录上标记一个旅客整体出行的频率。在继续执行示例时，请按以下步骤深入研究这些计算：

1. 我们将从计算开始，以确定购票到旅行当天的时间长度。选择Clean 3步骤，然后单击Create Calculated Field。命名计算Days from Purchase to Travel并输入

   DATEDIFF('day', [Purchase Date], [Travel Date])。

2. 在“ **配置文件”**窗格中检查结果。新字段应如下所示：

![img](../images/000260.gif)

此处的默认视图（在许多情况下为数字字段）是汇总的直方图。您可以通过选择字段右上角的“ **选项”**按钮并切换到“ 细节”来更改视图以查看其详细信息，该视图将显示该字段的每个值：

![img](../images/Image%20[287].jpg)

默认的“ 摘要”直方图指示的数据形状与大多数人在旅行日期（但不是紧接之前）购买机票时所期望的形状接近。可能有一些机会可以通过提前购买更多商品来获得更好的交易，因此确定这种模式（然后在Tableau Desktop中进行更充分的研究）将是我们分析的关键。

我们可能还希望能够根据旅客旅行的频率对其进行分组。我们将使用一些聚合和计算来完成此任务。

1. 将鼠标悬停在“ 清理3”步骤上并选择“ 添加聚合 ”时，单击出现的**+**图标。名为Aggregate 1的新步骤将添加到流中。
2. 双击新步骤下的文本“ 聚合1 ”。这使您可以编辑名称。将名称从“ 聚合1”更改为Trips per person。

*为有意义的名称指定步骤，以自记录流程。**当您将来再次编辑流程时，这将对您和其他人有很大帮助。**此外，当您编辑步骤的名称时，“* *添加描述”**文本将出现在名称下方。*

参考前面的提示，您可以双击该区域以添加更长的描述以提供进一步的文档：

![img](../images/000170.gif)

选择聚合步骤将显示一个窗格，其中包含用于对流中的字段进行分组和聚合的选项：

![img](../images/Image%20[288].jpg)

您可以将字段从左侧拖放到“ 分组的字段”或“ 聚合的字段”部分，并可以通过单击聚合文本（例如SUM）并从结果下拉列表中选择其他聚合来更改聚合的类型。

在前面的屏幕截图中，您可以看到我们已经按Person分组，并将Number of  Rows作为SUM添加到了聚合字段中。“行数”是“聚合”步骤中可用的特殊字段。我们在这里使用它是因为每条记录都代表一个单独的旅程，因此，对每人的记录进行计数可以让我们知道他们进行了多少次旅程。在继续我们的示例时，我们将使用这些信息。

1. 将鼠标悬停在“ 总计每人行程”上，然后选择“ 添加步骤 ”，请点击出现的**+**图标。该流程的新步骤名为Clean 4。
2. 选择此新的**Clean**步骤，然后在**Profile**窗格中，双击Number of Rows字段的名称，将其重命名为Trips。
3. 创建一个新的计算字段Type of Traveler，其名称如下：

如果[Trips]> 15然后“极端”

ELSEIF [Trips]> 10然后“ Frequent”

ELSEIF [Trips]> 4然后“休闲”

ELSE“不常发生”

结束

此计算字段现在将标签每个人作为一个要么Extreme，Frequent，Casual，或Infrequent旅行者的基础上，他们有多少总行程做。此时，您可能会注意到该流仅包含“聚合”步骤中的字段（加上刚刚创建的计算字段）：

![img](../images/Image%20[289].jpg)

这是预期的，因为“聚合”步骤仅保留已分组或聚合的字段。有时，聚合的结果正是您要分析的结果。

但是，在这种情况下，我们希望补充原始数据集，以便我们可以将每个人标记为某种类型的旅行者。接下来，我们将完成该操作。

1. 拖动“ 清洁4”步骤并将鼠标悬停在“ 清洁3”步骤上。
2. 将“ 清理4”步骤放到出现的“ 连接”选项上。将显示“加入”步骤的设置窗格，允许您根据需要配置加入。请注意，Tableau Prep已根据名称和类型自动选择了最可能的联接字段：

![img](../images/Image%20[290].jpg)

花点时间检查“ **联接”**窗格的独特功能：

- Applied Join子句：在这里，您可以选择向Join子句添加条件，并确定应将哪些字段用作定义联接的键。您可以根据需要添加任意多个子句。
- 联接类型：您可以在此处定义联接的类型（内部，左侧，左侧内部，右侧，右侧内部或外部）。通过单击Venn图的各个部分以选择或取消选择要保留的联接部分来完成此操作。
- 连接结果摘要：条形图表示流的每个输入有多少条记录，有多少条匹配或不匹配，以及是否根据所选的连接类型将它们保留在结果数据集中。您可以单击一个条形段以在数据网格中查看过滤的结果。
- 连接条款建议：如果适用，Tableau Prep将显示可能的连接条款，然后单击即可添加。
- Join子句：Tableau Prep在此处显示Join子句中使用的字段和相应的值。任何不匹配的值将具有红色字体颜色。您可以通过双击来编辑值。这使您可以根据需要修复单个不匹配的值。

在我们的示例中，Tableau Prep自动将Person确定为联接输入和所有值之间的匹配字段，以按预期方式找到匹配项。此示例不需要采取进一步的措施，但是在某些情况下，您可能需要调整“连接子句”或修复不匹配的值。

*小心可能由于不正确的连接而创建的重复记录。**例如，您可能希望左连接保留左侧的所有记录，而只匹配右侧的某些记录。**确实如此，如果左侧的记录与右侧的多个记录匹配，则可以重复这些记录。**使用**联接结果摘要**来注意意外的结果。**请注意，数据采样还可能极大地影响摘要编号。*

通过添加另一个清洁步骤来扩展流程，该步骤应自动命名为Clean 5。此时，流程应类似于以下内容：

![img](../images/Image%20[291].jpg)

将聚合联接回原始数据集的结果与FIXED在Tableau Desktop中创建详细程度表达式非常相似。例如，在Tableau Desktop中，我们可能编写了如下表达式：

{FIXED [Person]：SUM（1）}

在桌面环境中，此表达式给出人员级别的记录数，并将该值返回到每一行。尽管无法在Tableau Prep中以相同的方式编写LOD计算，但我们通过聚合然后再加入流来完成相同的操作。我们将通过考虑过滤然后重塑数据以进行非常具体的视觉分析来结束我们的示例。

#### 在Tableau Prep中过滤 <div id="page_226"></div>

在Tableau Prep中有几种过滤方法：

- 过滤输入
- 流程内过滤

过滤输入可能是有效的，因为发送到数据源的查询将返回较少的记录。要过滤输入，请选择输入步骤，然后在输入窗格中单击“ 过滤值...”按钮：

![img](../images/Image%20[292].jpg)

弹出的“ 添加过滤器”对话框使您可以编写带有布尔（真/假）结果的计算。仅保留真值。

过滤还可以在流程中任何地方的干净步骤中完成。有几种应用过滤器的方法：

- 为给定字段选择一个或多个值，然后使用“ 仅保留”或“ 排除”选项。
- 使用字段上的“ **选项”**按钮可显示基于字段类型的多个过滤器选项。例如，可以通过计算，范围，相对值或空值来过滤日期：

![img](../images/Image%20[293].jpg)

- 选择一个字段，然后从工具栏中选择过滤值。与“ **输入”**窗格中过滤器的工作方式类似，系统将提示您编写代码，以对要保留的记录返回true。例如，如果您想保留在2016年1月1日或之后购买的记录，则可以编写如下代码：

[购买日期]> MAKEDATE（2016，1，1）

尽管在我们的示例中数据集不需要过滤，但是您可能希望尝试各种过滤技术。

#### 转换数据进行分析 <div id="page_227"></div>

此时，我们有一个非常有用的数据集可用于Tableau Desktop中的分析，但是我们可能还需要进行一些其他转换。如果我们想在地图上将此数据集中的飞行路径渲染出来怎么办？Tableau  Desktop中的一种方法需要一个数据集，该数据集的每个路径具有两个记录：一个记录的纬度和经度为起点，而另一个记录的纬度和经度为目的地点。

我们的数据集当前包含该路径的一条记录。我们有一个名为Route的字段，其中包含DAL-PHX和DFW-JFK之类的值。这些值对为我们提供了始发机场代码和目的地机场代码。借助一些补充数据和数据的转换，我们最终可以得到一种形状的数据，该形状可以使我们可视化机场之间的路径。

使用以下步骤结束本章的示例：

1. 在“ 清理5”步骤中找到“ 路由”字段，然后选择它。
2. 选择“ 路由”字段后，在窗格的工具栏上单击“ 自动拆分 ”。结果显示在这里：

![img](../images/Image%20[294].jpg)

该分段自动评估基于一个共同的分隔符领域，试图分裂。在这种情况下，破折号被标识为可能的值定界符，并且“ 自动拆分”将在另外两个字段中产生结果。

*配置文件窗格右上方的**“* **搜索”***框使您可以快速在配置文件窗格中查找字段。**route**在前面的示例中**键入**将找到原始**Route**字段以及两个拆分字段。*

1. 分别将Route-Split 1和Route-Split 2分别重命名为**Origin**和**Destination**。

我们仍然在同一记录中同时包含起点和终点，并且我们的目标是为起点和终点都有一条记录。幸运的是，通过Tableau Prep，可以轻松地将数据从列重整为行（或者，如果需要，也可以将行重整为列）。您将通过枢轴完成此任务。

1. 使用“ 清理5”步骤上的**+**图标，选择添加枢轴。
2. 枢轴窗格为您提供了将行转换为列或将列转换为行的选项。我们将保留默认选项。将Origin和Destination字段都拖到窗格的Pivot 1 Values区域中：

*对于列到行，“* *透视值”**将是一列，其中包含**透视**字段的所有值。**“* *数据透视名称”**将是一列，其中包含原始列的名称。*

![img](../images/Image%20[295].jpg)

1. 双击“ 数据透视1值”的文本，然后将该字段重命名为Airport Code。该字段将包含始发地和目的地记录的所有机场代码。
2. 双击“ 数据透视1名称”的文本，然后将该字段重命名为Route Point。此字段会将每个记录标记为Origin或Destination。

至此，我们有了一个数据集，其中包含旅程的每个终点（起点或终点）的一条记录。

*注意，数据透视导致重复的数据。**曾经是一个字段（原点和目的地一起）的现在是两个字段。**记录数增加了一倍，因此我们无法再对记录数进行计数来确定行程数。**我们也无法**SUM**支付机票费用，因为它将使机票重复计算。**我们需要使用**MIN**/* *MAX**/* *AVG**或某种看只有起点或目的地的细节表达或过滤的水平。**尽管许多转换允许我们实现某些目标，但我们必须意识到它们可能会带来其他复杂性。*

我们目前唯一的位置信息是机场代码。尽管Tableau Desktop包含机场代码的地理编码，但我们将为每个点补充实际的纬度和经度值：

1. 添加一个新的数据连接，选择Tableau Extract作为类型。
2. 找到并US Airports.hyper在\Learning Tableau\Chapter 10目录中选择。此文件包含许多美国机场代码的地理编码。
3. 输入步骤应自动添加，因为摘录仅包含一个数据表。将此新输入拖动到“ 数据透视1”步骤中，并将其放在“ 联接”选项上。Tableau Prep将创建一个新的联接步骤，并应自动将“ 机场代码”检测为联接两侧之间匹配的字段。
4. 现在，我们的数据集包含所有必需的数据。通过添加最终输出来完成流程。将类型设置为.csv，浏览到\Learning Tableau\Chapter 10目录，然后为文件命名Employee Flights.csv。

*输出步骤可以被配置为作为的Tableau服务器的数据连接或以输出此发布所产生的数据到文件的类型**.csv**，**.tde**（的Tableau数据提取物），或**.hyper**（超数据提取物）。*

现在，您可以通过使用工具栏顶部的“运行”按钮或单击输出步骤上的“运行”按钮来运行流程。一旦执行了流程，请打开目录中的Employee Travel.twb工作簿，\Learning Tableau\Chapter 10以查看如何使用数据并自行进行研究：

![img](../images/Image%20[296].jpg)

*与**文件**.tde**或**.hyper**文件**不同**.csv**，即使文件已在Tableau Desktop中作为数据源打开，也可能会写入文件。**如果您运行试图覆盖**正在使用**的**.tde**或**.hyper**文件**的流，则会收到错误消息**。**此外，您可以**.csv**通过在输出之前将字段拖放到干净步骤的配置文件窗格中**来重新排列**文件**的字段顺序**。*

#### 流程自动化选项 <div id="page_228"></div>

Tableau Prep  Builder允许您使用应用程序设计和运行流程。有时，数据清理和准备将是一次性的操作，以支持即席分析。但是，您通常会希望随后运行一个流程来捕获新数据或更改过的数据，并根据相同的模式对其进行清理和整形。在这些情况下，您将需要考虑一些用于使流程自动化的选项：

- **Tableau Prep Builder**可以通过命令行运行。您可以提供JSON文件来定义用于输入或输出数据连接的凭据。这使您可以使用脚本编制和调度实用程序来运行流，而无需手动打开和运行Tableau Prep界面。有关此选项的详细信息，请参见Tableau帮助：[https](https://onlinehelp.tableau.com/current/prep/en-us/prep_save_share.htm#refresh-output-files-from-the-command-line) : [//onlinehelp.tableau.com/current/prep/en-us/prep_save_share.htm#refresh-output-files-from-the-command-line](https://onlinehelp.tableau.com/current/prep/en-us/prep_save_share.htm#refresh-output-files-from-the-command-line)。
- **Tableau Prep Conductor**（Tableau Server的一项附加功能）使您能够将整个流从Tableau Prep Builder发行到Tableau Server，然后按需或按自定义计划运行它们。它还提供监视和故障排除功能。

### 总结 <div id="page_229"></div>

Tableau Prep具有即时反馈的动手数据清理和整形的创新范例极大地扩展了Tableau平台，并为您提供了对数据的不可思议的控制。在本章中，我们考虑了整个界面以及它如何允许您迭代快速地构建逻辑流程，以清理和整形数据以进行所需的分析或可视化。

通过贯穿本章的复杂而又实用的示例，我们探索了Tableau Prep中的每个重大转变，从输入到联合，联接，集合和枢轴，再到输出。在此过程中，我们还检查了其他转换和功能，例如计算，拆分，合并和值分组。这为您以任何需要的方式成型和成形数据奠定了基础。

在下一章中，我们将再次返回Tableau Desktop，以探索一些高级技术和可视化类型！

